# 延迟变量扩展


本节掌握三个重点就掌握了：
- 1、cmd中也有类似于C语言中的“预处理”的概念，但是它的预处理和C语言不同
- 2、命令行解释器在解析执行批处理文件时是将一条完整的命令来解析执行的。（另外例如if，for命令等，其后用一对圆括号闭合的所有语句也当作一行）
- 3、记住能够实现“延迟”变量拓展的命令！！！
 - 是的现象和在C语言、matlab、python、java中一样。



还有一个知识点需要和大家讲一下，当我们在批处理文件中设置了一个变量，比如：var那么，当我们var这个变量设置完以后，系统就会给它分配一个存储单元。在我们批处理要调用这个变量的时候它就会在系统中找到var这个变量所对应的值。然后供批处理使用。家一定要理解这是什么意思在很多的编程语言中同样如此，只不过有点语言是这样定义的，不同的类型说明符、那么在系统内存中所占的字节也不同。







### 一、现象引出概念（批处理中的“预处理”）


#### （1）测试样例
例子：
```bat
rem 批处理
@echo off
set a=100
set a=2 & echo %a%
pause
```

测试
```txt
100
请按任意键继续. . .
```

大家有没有看出什么问题，首先我们给var这个变量赋了一个初值。然后又改变它的值，也就是2了。  
但为什么输入的时候我们看见的却是变量var的值还是100呢。



```txt
cmd在解释我们的命令的时候，首先会读取命令行一条完整的命令，然后对其进行一些命令格式的匹配操作，看你所输的命令格式是否正确。如果我们要在命令中引用一些变量，那么我们需要在变量的两边各加一个%号，使cmd在解释我们的命令的时候能够识别这个变量，例如%name%。当cmd读取我们的命令进行格式匹配的时候，就会发现name这个字符串两边各加了一个%，就不会把它当作普通字符串处理，而是把它当作一个变量处理，变量名就叫做name。然后cmd就会查找这个变量的值，用该值替换掉%name%，最后执行这个替换好的命令。这个替换的过程就叫做环境变量扩展。
```

它会有一个叫做**预处理**的过程。也就是将“set a=2&echo %a%”这一条完整的命令进行预处理。当然这个例子

**这条命令放在一行,表示他是一条完整的命令**

预处理之后，其实是这样的
```bat
set a=2 & echo 100
```




#### (2)测试样例
接下来，我们继续测试，在后面增加一行
```bat
@echo off
set a=100
set a=2 & echo %a%
echo %a%
pause
```

测试现象
```txt
100
2
请按任意键继续. . .
```
其实经过预处理之后：

```txt
@echo off
set a=100  ::设置%a%为1
set a=2 & echo 100 ::预处理中前一句没必要处理，后一句将%a%用对于的值替换，也就是那时候是100
```
预处理之后，继续下一行预处理
```bat
echo 2 ::由于在前面一行将%a%设置为2,这个时候预处理再次来替换
```






#### (3)for循环中的测试样例

**重点理解**概念：if，for命令等，其后用一对**圆括号**闭合的所有语句也当作**一行（注意是一行）**

```bat
rem 批处理
@echo off
set /a var = 99
for /l %%m in (1,1,5) do (
    set /a var = %%m
    echo %var%
)
pause
```
测试输出
```txt
99
99
99
99
99
请按任意键继续. . .
```


原理解释:
大家动下脑筋，set /a var=%%i是不是属于for里面的呀？  
显然，是的。  
那么这个时候问题就出现了。
当批处理执行到for这里的时候，那么CMD就对这条完整的命令进行检查，注意此时的set /a var=%%i这一条赋值命令是没有被执行的。

而是经过预处理之后变为了
```txt
rem 批处理
@echo off
set /a var = 99
for /l %%m in (1,1,5) do (
    set /a var = %%m
    echo 99  :: 预处理过的时候进行了，变量拓展
)
pause
```









### 二、概念构建

一句话“**CMD不能感知环境变量的动态变化**”。为了解决这个问题呢，CMD设计出了变量延迟
简单来说，在读取了一条完整的语句之后，不立即对该行的变量赋值，而会在某个单条语句执行之前再

进行赋值，也就是说“延迟”了对变量的赋值。

那么，我们如何来开启这个所谓的变量延迟呢。很简单，只需要在批处理文件的开始加上一句

“`setlocal enabledelayedexpansion`”就开启了变量延迟

看下面这个例子就是开去了变量延迟的批处理文件

例子：

```batch
@echo off
setlocal enabledelayedexpansion
for /l %%i in (1,1,5) do (
set a=%%i
echo !a!
)
pause
```

解释一下这个双引号，那么因为我们已经开启了变量延迟。所以要将变量的%号替换成!号了。

还有就是我们启用了“延迟环境变量扩展”后，那么CMD在执行涵有嵌套内容时。它就会把嵌套

的命令一条一条的先执行一次。通过这样，我们的嵌套赋值命令就执行了。

那么还拿第一个例子来说话，找到第一个例子

例子：

```cmd
@echo off
setlocal enabledelayedexpansion
set a=1
set a=2&echo !a!
pause
```



因为加了一个&符号，前面我们讲过的，如果加了&符号。那么CMD就把他们当作时一条完整的命令

首次可以看下没有开启变量延迟的效果，相信大家已经明白了吧





### 三、“延迟”变量拓展的命令

```bat
setloacl ENABLEDELAYEDEXPANSION
```

在批处理中,我们可以
用`setloacl ENABLEDELAYEDEXPANSION`这个命令来启用"延迟环境变量扩展" 

- 1、在我们启用了"延迟环境变量扩展"后,当CMD在解释涵有嵌套格式的命令时,他会把嵌套的命令一条一条的先执行一次,然后再进行匹配操作,这样我们的赋值操作就会完成.
- 2、并且再"延迟环境变量扩展"**启用后**,CMD会用!号来判断这是不是一个变量,如没启用来变量用%name%这样的格式判断,启用后就用`!name!`这样的格式判断了,这个符号我们需要注意!


例子:
```cmd
rem 批处理
@echo off
setlocal ENABLEDELAYEDEXPANSION
set var=test
for /l %%i in (1,1,5) do (
    set var=%%i
    echo !var!
)
```


这样大家应该明白什么是延迟环境变量扩展了吧.










### 四、其他

延迟变量全称"延迟环境变量扩展",要理解这个东西,我们还得先理解一下什么叫扩展!
CMD在解释我们的命令的时候,首先会读取命令行一条完整的命令,然后对其进行一些
命令格式的匹配操作,看你所输入的命令格式是不是符合他的要求.
如果我们要在我们的命令中引用一些变量,那么我们如何让CMD在解释我们的命令时,能识别出这个变量呢?
这时我们就可以在变量名字两边加一个%号,如%name%.当CMD在对读取我们的整行命令
进行格式匹配的时候,就会发现name这个字符两边加了%号,就不会把他当作普通字符处理,
而是会把他当作一个变量处理,变量名叫name!
然后CMD就会找到变量名对应的值,用变量名的值替换掉这个变量名字(name),(如果变量名不存在值,就返回空值).
再将这个替换好并且匹配的命令执行!这个替换值的过程,就叫做变量扩展,
说白了就是把变量的名字,用他的值给替换掉后执行!
也就是批处理如何识别一个变量的过程.


(注意:这里只是变量的扩展的意思,不是延迟环境变量扩展,要理解延迟环境变量扩展,必须先理解什么是变量的扩展)

也就是批处理如何识别一个变量的过程.  ~_~

例如这个一个BAT

```cmd
set var=test
echo %var%
```

CMD在读取到echo %var%这句命令后,就会进行匹配操作,它马上就发现var字符两边有%号,
这时他就会把他当作一个变量处理,查看这个var变量名是不是有值,如果有就用他的值把变量名var给替换掉,
这里我们的VAR在上一条命令set var=test中,给var赋值为test,所以他会用test把%var%这个变量名替换掉,
替换后的结果就为echo test了.
这些步骤都是CMD进行匹配操作的步骤,匹配完后,他再执行echo test这条语句,
这时我们的CMD中就会echo出一个test了.

什么是环境变量扩展知道了,那什么是延迟环境变量扩展呢?

在理解环境变量扩展时,我们知道CMD在解释命令时,首先会把一条完整的命令进行读取,
然后进行匹配操作,匹配时他会把命令里的变量用变量的值个替换掉,然后执行这个替换好的命令.
问题就出在"一条完整的命令",

在BAT中,IF FOR这样的命令都可以加括号,将一些命令嵌套在里面执行. 						111111111111111111111111111111111111111111
这样的话对于一条可以加扩号嵌其他命令的命令,他的完整格式就是
for %%i in (....)这样一个整体.
此时,如果我们如果在括号里面嵌入一些设置变量值的命令,就会出现问题了!       （个人觉得像C语言中函数中变量的作业域！看了后面又感觉不是的呀！）

看例子

```cmd
@echo off
for /l %%i in (1,1,5) do (
    set var=%%i
    echo %var%
)
```



执行后会显示5个空行的错误提示!为什么?根据我们上面说的知识来理解

```cmd
@echo off
set var=test
for /l %%i in (1,1,5) do (
    set var=%%i
    echo %var%
)
```



这个就会打印5个test了.（需要学习！！！）







